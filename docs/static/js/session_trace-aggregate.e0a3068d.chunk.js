"use strict";(self.webpackChunkfrosted_by_nes=self.webpackChunkfrosted_by_nes||[]).push([[193],{6945:(e,t,s)=>{let i;s.d(t,{m:()=>r});const n=new Promise((e=>{i=e})),r=Object.freeze({onReplayReady:i,sessionReplayInitialized:n})},394:(e,t,s)=>{s.r(t),s.d(t,{Aggregate:()=>H});var i=s(101),n=s(2346),r=s(4572),a=s(3889);var o=s(1519);function h(e,t,s){return function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=s}}(e,(0,o.Z)(e,t,"set"),s),s}var c=s(6033),u=s(4613),l=s(7661),d=s(4522),f=s(8958),m=s(6276),g=s(7772),p=new WeakMap,v=new WeakMap,w=new WeakMap,y=new WeakMap,T=new WeakSet,R=new WeakSet;class b{constructor(){(0,i.Z)(this,R),(0,i.Z)(this,T),(0,n.Z)(this,p,{writable:!0,value:void 0}),(0,n.Z)(this,v,{writable:!0,value:[]}),(0,n.Z)(this,w,{writable:!0,value:setTimeout((()=>(0,a.Z)(this,R,N).call(this)),5e3)}),(0,n.Z)(this,y,{writable:!0,value:!1})}settle(e){!1===(0,c.Z)(this,p)||(void 0===(0,c.Z)(this,p)?(0,c.Z)(this,v).push(e):e())}decide(e){(0,c.Z)(this,y)||(h(this,p,e),!1===e&&(0,a.Z)(this,R,N).call(this),!0===e&&(0,a.Z)(this,T,S).call(this))}permanentlyDecide(e){(0,c.Z)(this,y)||(this.decide(e),h(this,y,!0))}}function S(){(0,c.Z)(this,v).forEach((e=>e())),(0,a.Z)(this,R,N).call(this)}function N(){h(this,v,[]),clearTimeout((0,c.Z)(this,w))}var O=s(9471),Z=s(9700),E=s(6945);var F=s(1527);const A={global:{mouseup:!0,mousedown:!0},window:{load:!0,pagehide:!0},xhrOriginMissing:{ignoreAll:!0}},M={typing:[1e3,2e3],scrolling:[100,1e3],mousing:[1e3,2e3],touching:[1e3,2e3]},I=6e5;var k=new WeakMap,L=new WeakSet,K=new WeakSet,x=new WeakMap;class H extends F.m{constructor(e,t,s){var r;if(super(e,t,g.FEATURE_NAME),(0,i.Z)(this,K),(0,i.Z)(this,L),(0,n.Z)(this,k,{writable:!0,value:void 0}),(0,n.Z)(this,x,{writable:!0,value:0}),r=this,this.agentRuntime=(0,f.OP)(e),!this.agentRuntime.xhrWrappable)return;this.resourceObserver=null===s||void 0===s?void 0:s.resourceObserver,this.ptid="",this.trace={},this.nodeCount=0,this.sentTrace=null,this.harvestTimeSeconds=(0,f.Mt)(e,"session_trace.harvestTimeSeconds")||10,this.maxNodesPerHarvest=(0,f.Mt)(e,"session_trace.maxNodesPerHarvest")||1e3,this.isStandalone=!1;const a=new b,o=this.agentRuntime.session;this.operationalGate=a;const l=e=>{switch(e){case O.IK.ERROR:this.startTracing(a,!0);break;case O.IK.FULL:case!0:this.startTracing(a);break;case O.IK.OFF:default:a.decide(!1)}};let d,m=!1;this.ee.on(O.wO.UPDATE,((e,t)=>{t.sessionReplayMode===O.IK.FULL&&p()}));const p=()=>{var e;if((null===(e=this.agentRuntime)||void 0===e||null===(e=e.session)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.sessionReplayMode)===O.IK.FULL&&d!==O.IK.FULL){const e=d;d=O.IK.FULL,o.write({sessionTraceMode:d}),this.isStandalone=!1,e===O.IK.ERROR&&(0,c.Z)(this,k)?(this.trimSTNs(3e4),(0,c.Z)(this,k).runHarvest({needResponse:!0})):l(O.IK.FULL)}};if(o){(0,u.X)("errorAgg",(()=>{m=!0,p()}),this.featureName,this.ee);const t=()=>{var e,t;o.state.sessionTraceMode!==O.IK.OFF&&o.write({sessionTraceMode:O.IK.OFF}),a.permanentlyDecide(!1),d===O.IK.FULL&&(null===(e=(0,c.Z)(this,k))||void 0===e||e.runHarvest()),null===(t=(0,c.Z)(this,k))||void 0===t||t.stopTimer(!0),h(this,k,null)};this.waitForFlags(["stn","sr"]).then((async s=>{let[i,n]=s;if(n)if(this.ee.on("REPLAY_ABORTED",(()=>t())),this.ee.on(O.wO.RESUME,(()=>{const e=o.state.sessionTraceMode;e===O.IK.OFF?t():e===O.IK.FULL&&(0,c.Z)(this,k)&&!(0,c.Z)(this,k).started&&(0,c.Z)(this,k).runHarvest({needResponse:!0}),d=e})),this.ee.on(O.wO.PAUSE,(()=>{d=o.state.sessionTraceMode})),o.isNew){const t=await async function(e){try{const t=(0,Z.fP)();if((0,f.Mt)(e,"session_replay.enabled")&&"object"===typeof t.initializedAgents[e].features.session_replay&&await t.initializedAgents[e].features.session_replay.onAggregateImported)return await E.m.sessionReplayInitialized}catch(t){}return O.IK.OFF}(e);let s;t===O.IK.OFF&&(this.isStandalone=!0),s=!0===i||t===O.IK.ERROR&&m?O.IK.FULL:t,o.write({sessionTraceMode:d=s}),l(s)}else o.state.sessionReplayMode===O.IK.OFF&&(this.isStandalone=!0),l(d=o.state.sessionTraceMode);else this.isStandalone=!0,l(i)}))}else this.isStandalone=!0,(0,u.X)("rumresp-stn",(e=>l(e)),this.featureName,this.ee);(0,u.X)("bst",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeEvent(...t)))}),this.featureName,this.ee),(0,u.X)("bstResource",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeResources(...t)))}),this.featureName,this.ee),(0,u.X)("bstHist",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeHist(...t)))}),this.featureName,this.ee),(0,u.X)("bstXhrAgg",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeXhrAgg(...t)))}),this.featureName,this.ee),(0,u.X)("bstApi",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeSTN(...t)))}),this.featureName,this.ee),(0,u.X)("errorAgg",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.storeErrorAgg(...t)))}),this.featureName,this.ee),(0,u.X)("pvtAdded",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.settle((()=>r.processPVT(...t)))}),this.featureName,this.ee),this.drain()}startTracing(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];"undefined"!==typeof PerformanceNavigationTiming?this.storeTiming(window.performance.getEntriesByType("navigation")[0]):this.storeTiming(window.performance.timing),h(this,k,new l.o("resources",{onFinished:(0,a.Z)(this,L,U).bind(this),retryDelay:this.harvestTimeSeconds},this)),(0,c.Z)(this,k).harvest.on("resources",(0,a.Z)(this,K,P).bind(this)),!1===t&&(0,c.Z)(this,k).runHarvest({needResponse:!0}),e.decide(!0)}processPVT(e,t,s){this.storeTiming({[e]:t}),function(e,t){return"fi"===e&&!!t&&"number"===typeof t.fid}(e,s)&&this.storeEvent({type:"fid",target:"document"},"document",t,t+s.fid)}storeTiming(e){if(e)for(let t in e){let s=e[t];const i=t.toLowerCase();i.indexOf("size")>=0||i.indexOf("status")>=0||"number"===typeof s&&s>=0&&(s=Math.round(s),this.storeSTN({n:t,s:s,e:s,o:"document",t:"timing"}))}}storeEvent(e,t,s,i){if(this.shouldIgnoreEvent(e,t))return;const n={n:this.evtName(e.type),s:s,e:i,t:"event"};try{n.o=this.evtOrigin(e.target,t)}catch(r){n.o=this.evtOrigin(null,t)}this.storeSTN(n)}shouldIgnoreEvent(e,t){const s=this.evtOrigin(e.target,t);return e.type in A.global||(!(!A[s]||!A[s].ignoreAll)||!(!A[s]||!(e.type in A[s])))}evtName(e){switch(e){case"keydown":case"keyup":case"keypress":return"typing";case"mousemove":case"mouseenter":case"mouseleave":case"mouseover":case"mouseout":return"mousing";case"scroll":return"scrolling";case"touchstart":case"touchmove":case"touchend":case"touchcancel":case"touchenter":case"touchleave":return"touching";default:return e}}evtOrigin(e,t){let s="unknown";if(e&&e instanceof XMLHttpRequest){const t=this.ee.context(e).params;if(!t||!t.status||!t.method||!t.host||!t.pathname)return"xhrOriginMissing";s=t.status+" "+t.method+": "+t.host+t.pathname}else if(e&&"string"===typeof e.tagName&&(s=e.tagName.toLowerCase(),e.id&&(s+="#"+e.id),e.className))for(let i=0;i<e.classList.length;i++)s+="."+e.classList[i];return"unknown"===s&&("string"===typeof t?s=t:t===document?s="document":t===window?s="window":t instanceof FileReader&&(s="FileReader")),s}storeHist(e,t,s){const i={n:"history.pushState",s:s,e:s,o:e,t:t};this.storeSTN(i)}storeResources(e){e&&0!==e.length&&(e.forEach((e=>{if((0|e.fetchStart)<=(0,c.Z)(this,x))return;const t=(0,d.e)(e.name),s={n:e.initiatorType,s:0|e.fetchStart,e:0|e.responseEnd,o:t.protocol+"://"+t.hostname+":"+t.port+t.pathname,t:e.entryType};this.storeSTN(s)})),h(this,x,0|e[e.length-1].fetchStart))}storeErrorAgg(e,t,s,i){if("err"!==e)return;const n={n:"error",s:i.time,e:i.time,o:s.message,t:s.stackHash};this.storeSTN(n)}storeXhrAgg(e,t,s,i){if("xhr"!==e)return;const n={n:"Ajax",s:i.time,e:i.time+i.duration,o:s.status+" "+s.method+": "+s.host+s.pathname,t:"ajax"};this.storeSTN(n)}storeSTN(e){if(this.nodeCount>=this.maxNodesPerHarvest){if(this.isStandalone||this.agentRuntime.session.state.sessionTraceMode!==O.IK.ERROR)return;if(0===this.trimSTNs(3e4))return}this.isStandalone&&(0,m.z)()>=I||(this.trace[e.n]?this.trace[e.n].push(e):this.trace[e.n]=[e],this.nodeCount++)}trimSTNs(e){let t=0;const s=Math.max((0,m.z)()-e,0);return Object.keys(this.trace).forEach((e=>{const i=this.trace[e];let n=i.findIndex((e=>s<=e.e));0!==n&&(n<0?(n=i.length,delete this.trace[e]):i.splice(0,n),this.nodeCount-=n,t+=n)})),t}takeSTNs(e){this.resourceObserver||this.storeResources(window.performance.getEntriesByType("resource"));let t=1/0;const s=Object.entries(this.trace).flatMap((e=>{let[s,i]=e;const n=i.reduce(((e,t)=>!e||t.s<e?t.s:e),void 0);if(n<t&&(t=n),!(s in M))return i;const r=this.smearEvtsByOrigin(s),a=i.sort(((e,t)=>e.s-t.s)).reduce(r,{});return Object.values(a).flat()}),this);if(0===s.length)return{};let i;if(e&&(this.sentTrace=this.trace),this.trace={},this.nodeCount=0,this.agentRuntime.session){const e=!this.agentRuntime.session.state.traceHarvestStarted;i={fsh:Number(e)},e&&this.agentRuntime.session.write({traceHarvestStarted:!0})}return{qs:{st:this.agentRuntime.offset,hr:Number(!this.isStandalone),fts:this.agentRuntime.offset+t,n:s.length,...i},body:{res:s}}}smearEvtsByOrigin(e){const t=M[e][0],s=M[e][1],i={};return(n,r)=>{let a=n[r.o];a||(a=n[r.o]=[]);const o=i[r.o];return"scrolling"!==e||function(e){const t=4;return!!(e&&"number"===typeof e.e&&"number"===typeof e.s&&e.e-e.s<t)}(r)?o&&r.s-o.s<s&&o.e>r.s-t?o.e=r.e:(i[r.o]=r,a.push(r)):(i[r.o]=null,r.n="scroll",a.push(r)),n}}}function U(e){e.sent&&e.responseText&&!this.ptid&&(this.agentRuntime.ptid=this.ptid=e.responseText,(0,c.Z)(this,k).startTimer(this.harvestTimeSeconds)),e.sent&&e.retry&&this.sentTrace&&(Object.entries(this.sentTrace).forEach((e=>{let[t,s]=e;this.nodeCount>=this.maxNodesPerHarvest||(this.nodeCount+=s.length,this.trace[t]=this.trace[t]?s.concat(this.trace[t]):s)})),this.sentTrace=null)}function P(e){if(this.isStandalone){if(this.ptid&&(0,m.z)()>=I)e.isFinalHarvest=!0,this.operationalGate.permanentlyDecide(!1),(0,c.Z)(this,k).stopTimer(!0);else if(this.ptid&&this.nodeCount<=30&&!e.isFinalHarvest)return}else{const e=this.agentRuntime.session.state.sessionTraceMode;if(e===O.IK.OFF&&0===Object.keys(this.trace).length)return;if(e===O.IK.ERROR)return}return this.takeSTNs(e.retry)}(0,r.Z)(H,"featureName",g.FEATURE_NAME)}}]);
//# sourceMappingURL=session_trace-aggregate.e0a3068d.chunk.js.map