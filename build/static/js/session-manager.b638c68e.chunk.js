"use strict";(self.webpackChunkfrosted_by_nes=self.webpackChunkfrosted_by_nes||[]).push([[242],{9471:(e,t,s)=>{s.d(t,{IK:()=>w,wO:()=>E,uT:()=>M,$s:()=>S});var i=s(662),r=s(1760),n=s(8038),o=s(4836);class a{constructor(e,t){if(!e.onEnd)throw new Error("onEnd handler is required");if(!t)throw new Error("ms duration is required");this.onEnd=e.onEnd,this.initialMs=t,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,t)}create(e,t){return this.timer&&this.clear(),setTimeout((()=>e?e():this.onEnd()),t||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}var h=s(3980),c=s(2162),l=s(536),u=s(1043);class d extends a{constructor(e,t){super(e,t),this.onPause="function"===typeof e.onPause?e.onPause:()=>{},this.onRefresh="function"===typeof e.onRefresh?e.onRefresh:()=>{},this.onResume="function"===typeof e.onResume?e.onResume:()=>{},this.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch(i){}if(h.il&&e.ee){var s;if(e.ee){this.ee=e.ee;const t=(0,u.D)(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=s=>{var i;e.refreshEvents.includes(null===s||void 0===s||null===(i=s[0])||void 0===i?void 0:i.type)&&t()},e.ee.on("fn-end",this.refreshHandler)}(0,l.N)((e=>{"hidden"===e?this.pause():this.resume()}),!1,!1,null===(s=this.abortController)||void 0===s?void 0:s.signal)}}abort(){var e;this.clear(),null===(e=this.abortController)||void 0===e||e.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){this.refresh(),this.onResume()}refresh(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}var m=s(5950),v=s(8673),p=s(5894),f=s(6477),y=s(9025),g=s(1997);const w={OFF:0,FULL:1,ERROR:2},A={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:w.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:w.OFF,traceHarvestStarted:!1,custom:{}},E={PAUSE:"session-pause",RESET:"session-reset",RESUME:"session-resume",UPDATE:"session-update"},M={SAME_TAB:"same-tab",CROSS_TAB:"cross-tab"};class S{constructor(e){const{agentIdentifier:t,key:s,storage:i}=e;if(!t||!s||!i)throw new Error("Missing required field(s):".concat(t?"":" agentID").concat(s?"":" key").concat(i?"":" storage"));this.agentIdentifier=t,this.storage=i,this.state={},this.key=s,this.ee=o.ee.get(t),(0,m.em)(this.ee),this.setup(e),h.il&&(0,g.bP)("storage",(e=>{if(e.key===this.lookupKey){const t="string"===typeof e.newValue?JSON.parse(e.newValue):e.newValue;this.sync(t),this.ee.emit(E.UPDATE,[M.CROSS_TAB,this.state])}}))}setup(e){let{value:t=(0,i.ky)(16),expiresMs:s=c.oD,inactiveMs:r=c.Hb}=e;this.state={},this.sync(A),this.state.value=t,this.expiresMs=s,this.inactiveMs=r;const n=this.read();s?(this.state.expiresAt=(null===n||void 0===n?void 0:n.expiresAt)||this.getFutureTimestamp(s),this.expiresTimer=new a({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,r?(this.state.inactiveAt=(null===n||void 0===n?void 0:n.inactiveAt)||this.getFutureTimestamp(r),this.inactiveTimer=new d({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(E.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(E.PAUSE),this.write((0,v.D)(this.state,A))},ee:this.ee,refreshEvents:["click","keydown","scroll"]},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew=!Object.keys(n).length,this.isNew?this.write((0,v.D)(this.state,A),!0):this.sync(n),this.initialized=!0}get lookupKey(){return"".concat(c.Bq,"_").concat(this.key)}sync(e){Object.assign(this.state,e)}read(){try{const e=this.storage.get(this.lookupKey);if(!e)return{};const t="string"===typeof e?JSON.parse(e):e;return this.isInvalid(t)?{}:this.isExpired(t.expiresAt)?(this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset()):this.isExpired(t.inactiveAt)?(this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset()):t}catch(e){return(0,r.Z)("Failed to read from storage API",e),{}}}write(e){try{if(!e||"object"!==typeof e)return;return e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,(0,n.P)(this.state)),this.ee.emit(E.UPDATE,[M.SAME_TAB,this.state]),e}catch(t){return(0,r.Z)("Failed to write to the storage API",t),null}}reset(){try{var e,t,s,i;return this.initialized&&this.ee.emit(E.RESET),this.storage.remove(this.lookupKey),null===(e=this.inactiveTimer)||void 0===e||null===(t=e.abort)||void 0===t||t.call(e),null===(s=this.expiresTimer)||void 0===s||null===(i=s.clear)||void 0===i||i.call(s),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs}),this.read()}catch(r){return{}}}refresh(){const e=this.read();this.write({...e,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isExpired(e){return Date.now()>e}isInvalid(e){return!Object.keys(A).every((t=>Object.keys(e).includes(t)))}collectSM(e,t,s){let i,r;"duration"===e&&(i=this.getDuration(t,s),r="Session/Duration/Ms"),"expired"===e&&(r="Session/Expired/Seen"),"inactive"===e&&(r="Session/Inactive/Seen"),r&&(0,p.p)(f.xS,[r,i],void 0,y.D.metrics,this.ee)}getDuration(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.state,t=arguments.length>1?arguments[1]:void 0;const s=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-s}getFutureTimestamp(e){return Date.now()+e}syncCustomAttribute(e,t){if(h.il)if(null===t){const t=this.read();t.custom&&(delete t.custom[e],this.write({...t}))}else{const s=this.read();this.custom={...(null===s||void 0===s?void 0:s.custom)||{},[e]:t},this.write({...s,custom:this.custom})}}}},1043:(e,t,s)=>{function i(e){var t=this;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=(null===i||void 0===i?void 0:i.leading)||!1;let n;return function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];r&&void 0===n&&(e.apply(t,o),n=setTimeout((()=>{n=clearTimeout(n)}),s)),r||(clearTimeout(n),n=setTimeout((()=>{e.apply(t,o)}),s))}}function r(e){var t=this;let s=!1;return function(){if(!s){s=!0;for(var i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];e.apply(t,r)}}}s.d(t,{D:()=>i,Z:()=>r})},7924:(e,t,s)=>{s.d(t,{setupAgentSession:()=>u});var i=s(8958),r=s(7552),n=s(4836),o=s(4613),a=s(9471);class h{get(e){try{return localStorage.getItem(e)||void 0}catch(t){return""}}set(e,t){try{return void 0===t||null===t?this.remove(e):localStorage.setItem(e,t)}catch(s){}}remove(e){try{localStorage.removeItem(e)}catch(t){}}}class c{constructor(e){this.domain=e}get(e){try{var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));if(t)return t[2]}catch(s){return""}}set(e,t){try{const s="".concat(e,"=").concat(t,"; Domain=").concat(this.domain,"; Path=/");document.cookie=s}catch(s){}}remove(e){try{document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; Domain=").concat(this.domain,"; Path=/")}catch(t){}}}let l=0;function u(e){const t=(0,i.OP)(e);if(l++)return t.session;const s=(0,i.P_)(e).session,u=null!==s&&void 0!==s&&s.domain?new c(s.domain):new h;t.session=new a.$s({agentIdentifier:e,key:"SESSION",storage:u,expiresMs:null===s||void 0===s?void 0:s.expiresMs,inactiveMs:null===s||void 0===s?void 0:s.inactiveMs});const d=t.session.state.custom,m=(0,i.C5)(e);d&&(m.jsAttributes={...m.jsAttributes,...d});const v=n.ee.get(e);return(0,o.X)("api-setCustomAttribute",((e,s,i)=>{t.session.syncCustomAttribute(s,i)}),"session",v),(0,o.X)("api-setUserId",((e,s,i)=>{t.session.syncCustomAttribute(s,i)}),"session",v),(0,r.L)(e,"session"),t.session}}}]);
//# sourceMappingURL=session-manager.b638c68e.chunk.js.map