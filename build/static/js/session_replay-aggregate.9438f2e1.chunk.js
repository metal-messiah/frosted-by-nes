"use strict";(self.webpackChunkfrosted_by_nes=self.webpackChunkfrosted_by_nes||[]).push([[590],{6945:(s,e,t)=>{let i;t.d(e,{m:()=>n});const o=new Promise((s=>{i=s})),n=Object.freeze({onReplayReady:i,sessionReplayInitialized:o})},3685:(s,e,t)=>{t.r(e),t.d(e,{AVG_COMPRESSION:()=>b,Aggregate:()=>A,IDEAL_PAYLOAD_SIZE:()=>C,MAX_PAYLOAD_SIZE:()=>w,RRWEB_EVENT_TYPES:()=>S});var i=t(4572),o=t(4613),n=t(7661),a=t(1477),h=t(8038),r=t(8958),l=t(9471),d=t(1527),c=t(6945),m=t(6323),p=t(1760),g=t(3980),y=t(6477),u=t(5894),v=t(9025),R=t(8374),f=t(6276);const b=.12,S={DomContentLoaded:0,Load:1,FullSnapshot:2,IncrementalSnapshot:3,Meta:4,Custom:5},I={message:"Session was reset",sm:"Reset"},M={message:"Recorder failed to import",sm:"Import"},_={message:"429: Too Many Requests",sm:"Too-Many"},F={message:"Payload was too large",sm:"Too-Big"},E={message:"Session Entity was set to OFF on another tab",sm:"Cross-Tab"};let T,k,O;const w=1e6,C=64e3,K={[l.IK.ERROR]:15e3,[l.IK.FULL]:3e5,[l.IK.OFF]:0};class A extends d.m{constructor(s,e){super(s,e,a.t),this.events=[],this.backloggedEvents=[],this.harvestTimeSeconds=(0,r.Mt)(this.agentIdentifier,"session_replay.harvestTimeSeconds")||60,this.initialized=!1,this.errorNoticed=!1,this.mode=l.IK.OFF,this.blocked=!1,this.recording=!1,this.shouldCompress=!0,this.hasSnapshot=!1,this.hasMeta=!1,this.hasError=!1,this.cycleTimestamp=void 0,this.payloadBytesEstimation=0,this.lastMeta=void 0,this.entitled=!1;const t=!0===(0,r.Mt)(s,"privacy.cookies_enabled")&&!0===(0,r.Mt)(s,"session_trace.enabled");this.stopRecording=()=>{},t&&(this.ee.on(l.wO.RESET,(()=>{this.abort(I)})),this.ee.on(l.wO.PAUSE,(()=>{this.stopRecording()})),this.ee.on(l.wO.RESUME,(()=>{const{session:s}=(0,r.OP)(this.agentIdentifier);this.mode=s.state.sessionReplayMode,this.initialized&&this.mode!==l.IK.OFF&&this.startRecording()})),this.ee.on(l.wO.UPDATE,((s,e)=>{this.initialized&&!this.blocked&&s===l.uT.CROSS_TAB&&(this.mode!==l.IK.OFF&&e.sessionReplayMode===l.IK.OFF&&this.abort(E),this.mode=e.sessionReplay)})),this.scheduler=new n.o("browser/blobs",{onFinished:this.onHarvestFinished.bind(this),retryDelay:this.harvestTimeSeconds,getPayload:this.prepareHarvest.bind(this),raw:!0},this),(0,o.X)("recordReplay",(()=>{!this.blocked&&this.entitled&&(T?this.mode!==l.IK.FULL&&this.switchToFull():this.initializeRecording(!1,!0,!0))}),this.featureName,this.ee),(0,o.X)("pauseReplay",(()=>{this.forceStop(this.mode!==l.IK.ERROR)}),this.featureName,this.ee),(0,o.X)("errorAgg",(s=>{this.hasError=!0,this.errorNoticed=!0,this.mode===l.IK.ERROR&&"visible"===(null===g._A||void 0===g._A?void 0:g._A.document.visibilityState)&&this.switchToFull()}),this.featureName,this.ee),this.waitForFlags(["sr"]).then((s=>{let[e]=s;this.entitled=e,this.initializeRecording(100*Math.random()<(0,r.Mt)(this.agentIdentifier,"session_replay.error_sampling_rate"),100*Math.random()<(0,r.Mt)(this.agentIdentifier,"session_replay.sampling_rate"))})).then((()=>c.m.onReplayReady(this.mode))),this.drain())}switchToFull(){this.mode=l.IK.FULL,T&&this.initialized&&(this.stopRecording(),this.startRecording(),this.scheduler.startTimer(this.harvestTimeSeconds),this.syncWithSessionManager({sessionReplayMode:this.mode}))}async initializeRecording(s,e,i){if(this.initialized=!0,!this.entitled||this.recording)return;const{session:o}=(0,r.OP)(this.agentIdentifier);if(o.isNew||i)if(e)this.mode=l.IK.FULL;else{if(!s)return;this.mode=l.IK.ERROR}else this.mode=o.state.sessionReplayMode;this.mode===l.IK.ERROR&&this.errorNoticed&&(this.mode=l.IK.FULL);try{T=(await t.e(538).then(t.bind(t,3498))).record}catch(n){return this.abort(M)}this.mode===l.IK.FULL&&this.scheduler.startTimer(this.harvestTimeSeconds);try{const{gzipSync:s,strToU8:e}=await t.e(675).then(t.bind(t,1617));k=s,O=e}catch(n){this.shouldCompress=!1}this.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}prepareHarvest(){if(0===this.events.length||this.mode!==l.IK.FULL&&!this.blocked)return;const s=this.getHarvestContents();if(!s.body.length)return void this.clearBuffer();this.shouldCompress?(s.body=k(O((0,h.P)(s.body))),this.scheduler.opts.gzip=!0):this.scheduler.opts.gzip=!1;const{session:e}=(0,r.OP)(this.agentIdentifier);return e.state.sessionReplaySentFirstChunk||this.syncWithSessionManager({sessionReplaySentFirstChunk:!0}),this.clearBuffer(),[s]}getHarvestContents(){var s,e,t,i,o;const n=(0,r.OP)(this.agentIdentifier),a=(0,r.C5)(this.agentIdentifier),h=null===(s=a.jsAttributes)||void 0===s?void 0:s["enduser.id"];this.backloggedEvents.length&&(this.events=[...this.backloggedEvents,...this.events]);(null===(e=this.events[0])||void 0===e?void 0:e.type)===S.FullSnapshot&&this.lastMeta&&(this.hasMeta=!0,this.events.unshift(this.lastMeta),this.lastMeta=void 0);(null===(t=this.events[this.events.length-1])||void 0===t?void 0:t.type)===S.Meta&&(this.lastMeta=this.events[this.events.length-1],this.events=this.events.slice(0,this.events.length-1),this.hasMeta=!!this.events.find((s=>s.type===S.Meta)));const l=(0,r.OP)(this.agentIdentifier).offset,d=(0,f.z)(),c=null===(i=this.events[0])||void 0===i?void 0:i.timestamp,p=null===(o=this.events[this.events.length-1])||void 0===o?void 0:o.timestamp,g=c||this.cycleTimestamp,y=p||l+d;return{qs:{browser_monitoring_key:a.licenseKey,type:"SessionReplay",app_id:a.applicationID,protocol_version:"0",attributes:(0,m.j6)({...this.shouldCompress&&{content_encoding:"gzip"},"replay.firstTimestamp":g,"replay.firstTimestampOffset":g-l,"replay.lastTimestamp":y,"replay.durationMs":y-g,"replay.nodes":this.events.length,"session.durationMs":n.session.getDuration(),agentVersion:n.version,session:n.session.state.value,rst:d,hasMeta:this.hasMeta,hasSnapshot:this.hasSnapshot,hasError:this.hasError,isFirstChunk:!1===n.session.state.sessionReplaySentFirstChunk,decompressedBytes:this.payloadBytesEstimation,"rrweb.version":R.lF,...h&&{"enduser.id":h}},5e3).substring(1)},body:this.events}}onHarvestFinished(s){429===s.status&&this.abort(_),this.blocked&&this.scheduler.stopTimer(!0)}clearBuffer(){this.mode===l.IK.ERROR?this.backloggedEvents=this.events:this.backloggedEvents=[],this.events=[],this.hasSnapshot=!1,this.hasMeta=!1,this.hasError=!1,this.payloadBytesEstimation=0,this.clearTimestamps()}startRecording(){if(!T)return(0,p.Z)("Recording library was never imported"),this.abort(M);this.recording=!0;const{block_class:s,ignore_class:e,mask_text_class:t,block_selector:i,mask_input_options:o,mask_text_selector:n,mask_all_inputs:a,inline_images:h,inline_stylesheet:l,collect_fonts:d}=(0,r.Mt)(this.agentIdentifier,"session_replay"),c=T({emit:this.store.bind(this),blockClass:s,ignoreClass:e,maskTextClass:t,blockSelector:i,maskInputOptions:o,maskTextSelector:n,maskAllInputs:a,inlineImages:h,inlineStylesheet:l,collectFonts:d,checkoutEveryNms:K[this.mode]});this.stopRecording=()=>{this.recording=!1,c()}}store(s,e){if(this.setTimestamps(),this.blocked)return;const t=(0,h.P)(s).length,i=this.getPayloadSize(t);if(i>w)return this.clearBuffer(),this.abort(F);this.mode===l.IK.ERROR&&e&&s.type===S.Meta&&this.clearBuffer(),s.type===S.Meta&&(this.hasMeta=!0),s.type===S.FullSnapshot&&(this.hasSnapshot=!0),this.events.push(s),this.payloadBytesEstimation+=t,i>C&&this.mode!==l.IK.ERROR&&this.scheduler.runHarvest()}takeFullSnapshot(){T&&T.takeFullSnapshot()}setTimestamps(){this.cycleTimestamp||(this.cycleTimestamp=(0,r.OP)(this.agentIdentifier).offset+g._A.performance.now())}clearTimestamps(){this.cycleTimestamp=void 0}getPayloadSize(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.estimateCompression(this.payloadBytesEstimation+s)+5e3}forceStop(s){s&&this.scheduler.runHarvest(),this.mode=l.IK.OFF,this.stopRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}abort(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,p.Z)("SR aborted -- ".concat(s.message)),(0,u.p)(y.xS,["SessionReplay/Abort/".concat(s.sm)],void 0,v.D.metrics,this.ee),this.blocked=!0,this.mode=l.IK.OFF,this.stopRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode}),this.clearTimestamps(),this.ee.emit("REPLAY_ABORTED")}estimateCompression(s){return this.shouldCompress?s*b:s}syncWithSessionManager(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{session:e}=(0,r.OP)(this.agentIdentifier);e.write(s)}}(0,i.Z)(A,"featureName",a.t)}}]);
//# sourceMappingURL=session_replay-aggregate.9438f2e1.chunk.js.map